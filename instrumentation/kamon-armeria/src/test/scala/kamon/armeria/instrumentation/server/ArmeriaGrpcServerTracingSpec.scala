package kamon.armeria.instrumentation.server

import com.linecorp.armeria.client.Clients
import com.linecorp.armeria.common.grpc.GrpcSerializationFormats
import com.linecorp.armeria.server.grpc.GrpcService
import kamon.armeria.instrumentation.grpc.GrpcExample.{ArmeriaHelloServiceGrpc, HelloRequest}
import kamon.tag.Lookups.{plain, plainLong}
import kamon.testkit.TestSpanReporter
import org.scalatest.OptionValues.convertOptionToValuable
import org.scalatest.concurrent.Eventually
import org.scalatest.{BeforeAndAfterAll, Matchers, WordSpec}
import utils.ArmeriaHelloGrpcService
import utils.ArmeriaServerSupport.startArmeriaServer

import scala.concurrent.ExecutionContext
import scala.concurrent.duration.DurationInt


class ArmeriaGrpcServerTracingSpec extends WordSpec
  with Matchers
  with BeforeAndAfterAll
  with Eventually
  with TestSpanReporter {

  val interface = "127.0.0.1"
  val httpPort = 8080

  val helloService =
    Clients.newClient(s"gproto+http://$interface:$httpPort/", classOf[ArmeriaHelloServiceGrpc.ArmeriaHelloServiceBlockingStub])

  val grpcService: GrpcService =
    GrpcService.builder()
      .addService(ArmeriaHelloServiceGrpc.bindService(new ArmeriaHelloGrpcService, ExecutionContext.global))
      .supportedSerializationFormats(GrpcSerializationFormats.values)
      .enableUnframedRequests(true)
      .build()

  private val httpServer = startArmeriaServer(httpPort, grpcService = Some(grpcService))

  "An application exposing Armeria gRPC services" should {
    "generate Spans with the name of the service" in {
      val reply = helloService.hello(HelloRequest("Kamon"))

      reply.message shouldBe "Hello, Kamon!"

      eventually(timeout(3 seconds)) {
        val span = testSpanReporter().nextSpan().value
        span.operationName shouldBe "ArmeriaHelloService/Hello"
        span.hasError shouldBe false
        span.metricTags.get(plain("component")) shouldBe "armeria.http.server"
        span.metricTags.get(plain("http.method")) shouldBe "POST"
        span.metricTags.get(plainLong("http.status_code")) shouldBe 200L
      }
    }
  }

  override protected def afterAll(): Unit =
    httpServer.close()

}
